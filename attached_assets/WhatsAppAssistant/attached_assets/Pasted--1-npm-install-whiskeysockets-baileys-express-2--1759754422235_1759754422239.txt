 ×©×œ×‘ 1 â€“ ×”×ª×§× ×ª ×”×¡×¤×¨×™×•×ª

npm install @whiskeysockets/baileys express
×©×œ×‘ 2 â€“ ×™×¦×™×¨×ª ××•×“×•×œ ×•×•××˜×¡××¤ 
×¦×•×¨ ×ª×™×§×™×™×” /services/whatsapp/×•×§×•×‘×¥ whatsapp.js:

// /services/whatsapp/whatsapp.js
import makeWASocket, { useMultiFileAuthState, fetchLatestBaileysVersion } from "@whiskeysockets/baileys";

let sock;

export async function connectWhatsApp() {
  const { state, saveCreds } = await useMultiFileAuthState("./auth_info");
  const { version } = await fetchLatestBaileysVersion();

  sock = makeWASocket({
    version,
    printQRInTerminal: true, // QR ×™×•×¤×™×¢ ×¨×§ ×¤×¢× ×¨××©×•× ×”
    auth: state,
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("connection.update", (update) => {
    const { connection } = update;
    if (connection === "open") console.log("âœ… ×•×•××˜×¡××¤ ××—×•×‘×¨!");
    else if (connection === "close") console.log("âŒ ×”×—×™×‘×•×¨ ×œ×•×•××˜×¡××¤ × ×¡×’×¨");
  });
}

export async function sendMessage(phone, message) {
  if (!sock) throw new Error("×•×•××˜×¡××¤ ×œ× ××—×•×‘×¨ ×¢×“×™×™×Ÿ!");
  // phone ×¦×¨×™×š ×œ×”×™×•×ª ×‘×¤×•×¨××˜ ××œ× +972501234567
  await sock.sendMessage(`${phone}@s.whatsapp.net`, { text: message });
}
âœ… ×”×¢×¨×” ×—×©×•×‘×”: 
* ×§×•×“ QR ×™×•×¤×™ ×¤×¢× ××—×ª ×‘×œ×‘×“ . * ××—×¨×™ ×©×”××¢×¨×›×ª ×©×•××¨×ª ××ª ×”Ö¾auth_info, ××¤×©×¨ ×œ×©×œ×•×— ×”×•×“×¢×•×ª ×‘×œ×™ ×œ×¡×¨×•×§ ×©×•×‘.
 ×©×œ×‘ 3 â€“ ××¢×¨×›×•×ª ×”×©×™×œ×•×‘ ×©×œ×š ×¢× ×›×¤×ª×•×¨ 
× × ×™×— ×©×™×© ×œ×š ××¢×¨×›×ª API Express CRM ×©×œ×š. ×ª×™×¦×•×¨ ××¡×œ×•×œ ×œ×©×œ×™×—×ª ×”×•×“×¢×”:

import express from "express";
import { connectWhatsApp, sendMessage } from "./services/whatsapp/whatsapp.js";

const app = express();
app.use(express.json());

// ×”×¤×¢×œ×” ×©×œ ×•×•××˜×¡××¤ ×›×©×©×¨×ª ×¢×•×œ×”
connectWhatsApp();

// API ×œ×©×œ×™×—×ª ×”×•×“×¢×” â€“ × ×™×ª×Ÿ ×œ×—×‘×¨ ×œ×›×¤×ª×•×¨ ×‘×××©×§ ×”-CRM
app.post("/api/send-whatsapp", async (req, res) => {
  try {
    const { phone, message } = req.body;
    await sendMessage(phone, message);
    res.json({ success: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.listen(3000, () => console.log("ğŸš€ ×”-CRM ×¨×¥ ×¢×œ ×¤×•×¨×˜ 3000"));
×©×œ×‘ 4 â€“ ×—×™×‘×•×¨ ×›×¤×ª×•×¨ ×‘×××©×§ ×”-CRM 
× × ×™×— ×©×™×© ×œ×š ×›×¤×ª×•×¨ HTML ××• ×ª×’×•×‘×”:

<button onclick="sendWhatsApp()">×©×œ×— ×”×•×“×¢×”</button>

<script>
async function sendWhatsApp() {
  const phone = "972501234567"; // ××¡×¤×¨ ×”××•×¢××“
  const message = "×©×œ×•×! ×–×• ×”×•×“×¢×” ××”×××©×§";
  
  const res = await fetch("/api/send-whatsapp", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ phone, message })
  });

  const data = await res.json();
  if (data.success) alert("âœ… ×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!");
  else alert("âŒ ×©×’×™××”: " + data.error);
}
</script>
×”×§×•×“ ×©×œ×š × ×¨××” ×˜×•×‘ ×‘×¡×™×¡×™, ××‘×œ ×™×© ×œ×™ ×›××” ×”××œ×¦×•×ª ×—×©×•×‘×•×ª ×œ×©×™×¤×•×¨:

ğŸ”´ ×‘×¢×™×•×ª ×§×¨×™×˜×™×•×ª ×©×¦×¨×™×š ×œ×ª×§×Ÿ:
1. × ×™×”×•×œ ××¦×‘ ×”×—×™×‘×•×¨
×”×‘×¢×™×” ×”×™× ×©××™×Ÿ ×˜×™×¤×•×œ ×‘××¦×‘×™ ×—×™×‘×•×¨ ××•×¨×›×‘×™×:

×’'××•×•×”×¡×§×¨×™×¤×˜
// ×”×•×¡×£ ×œ××•×“×•×œ whatsapp.js
let connectionStatus = 'disconnected';
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

export async function connectWhatsApp() {
  const { state, saveCreds } = await useMultiFileAuthState("./auth_info");
  const { version } = await fetchLatestBaileysVersion();

  sock = makeWASocket({
    version,
    printQRInTerminal: true,
    auth: state,
    // ×”×•×¡×£ ××¤×©×¨×•×™×•×ª ×—×©×•×‘×•×ª:
    defaultQueryTimeoutMs: undefined,
    keepAliveIntervalMs: 30000,
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("connection.update", async (update) => {
    const { connection, lastDisconnect, qr } = update;
    
    if (qr) {
      console.log("ğŸ“± ×¡×¨×•×§ ××ª ×”-QR code");
    }
    
    if (connection === "open") {
      console.log("âœ… ×•×•××˜×¡××¤ ××—×•×‘×¨!");
      connectionStatus = 'connected';
      reconnectAttempts = 0;
    } else if (connection === "close") {
      connectionStatus = 'disconnected';
      const shouldReconnect = lastDisconnect?.error?.output?.statusCode !== 401;
      
      if (shouldReconnect && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
        reconnectAttempts++;
        console.log(`ğŸ”„ ×× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×© (× ×™×¡×™×•×Ÿ ${reconnectAttempts})...`);
        setTimeout(() => connectWhatsApp(), 5000);
      } else if (lastDisconnect?.error?.output?.statusCode === 401) {
        console.log("âŒ × ×“×¨×© ×œ×¡×¨×•×§ QR ××—×“×© - ××—×§ ××ª ×ª×™×§×™×™×ª auth_info");
      }
    }
  });
}

// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ××¦×‘
export function isConnected() {
  return connectionStatus === 'connected' && sock;
}
2. ×•×œ×™×“×¦×™×” ×©×œ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ
×’'××•×•×”×¡×§×¨×™×¤×˜
function formatPhoneNumber(phone) {
  // ×”×¡×¨ ×¨×•×•×—×™× ×•×ª×•×•×™× ××™×•×—×“×™×
  phone = phone.replace(/\D/g, '');
  
  // ×× ××ª×—×™×œ ×‘-0, ×”×—×œ×£ ×œ-972
  if (phone.startsWith('0')) {
    phone = '972' + phone.substring(1);
  }
  
  // ×× ×œ× ××ª×—×™×œ ×‘-972, ×”×•×¡×£
  if (!phone.startsWith('972')) {
    phone = '972' + phone;
  }
  
  return phone;
}

export async function sendMessage(phone, message) {
  if (!isConnected()) {
    throw new Error("×•×•××˜×¡××¤ ×œ× ××—×•×‘×¨ - × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨");
  }
  
  phone = formatPhoneNumber(phone);
  
  try {
    await sock.sendMessage(`${phone}@s.whatsapp.net`, { text: message });
    console.log(`âœ… ×”×•×“×¢×” × ×©×œ×—×” ×œ-${phone}`);
    return { success: true, phone };
  } catch (error) {
    console.error(`âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” ×œ-${phone}:`, error);
    throw error;
  }
}
3. × ×§×•×“×ª ×§×¦×” ×©×œ ×”×¢×‘×¨×ª ×”-API
×’'××•×•×”×¡×§×¨×™×¤×˜
// ×”×•×¡×£ middleware ×œ×‘×“×™×§×ª rate limiting
const messageQueue = new Map();

app.post("/api/send-whatsapp", async (req, res) => {
  try {
    const { phone, message } = req.body;
    
    // ×•×œ×™×“×¦×™×”
    if (!phone || !message) {
      return res.status(400).json({ 
        error: "×—×¡×¨×™× ×¤×¨××˜×¨×™×: phone ×•-message × ×“×¨×©×™×" 
      });
    }
    
    if (!isConnected()) {
      return res.status(503).json({ 
        error: "×•×•××˜×¡××¤ ×œ× ××—×•×‘×¨ ×›×¨×’×¢",
        status: "disconnected"
      });
    }
    
    // ×‘×“×™×§×ª rate limit (×œ×× ×•×¢ ×¡×¤××)
    const lastSent = messageQueue.get(phone);
    if (lastSent && Date.now() - lastSent < 3000) {
      return res.status(429).json({ 
        error: "×”××ª×Ÿ 3 ×©× ×™×•×ª ×‘×™×Ÿ ×”×•×“×¢×•×ª ×œ××•×ª×• ××¡×¤×¨" 
      });
    }
    
    await sendMessage(phone, message);
    messageQueue.set(phone, Date.now());
    
    res.json({ success: true, phone });
  } catch (err) {
    console.error("×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”:", err);
    res.status(500).json({ error: err.message });
  }
});

// API ×œ×‘×“×™×§×ª ×¡×˜×˜×•×¡
app.get("/api/whatsapp-status", (req, res) => {
  res.json({ 
    connected: isConnected(),
    status: connectionStatus 
  });
});
4. ×©×™×¤×•×¨ ×”×¤×¨×•× ×˜-×× ×“
×’'××•×•×”×¡×§×¨×™×¤×˜
async function sendWhatsApp() {
  const button = event.target;
  button.disabled = true;
  button.textContent = "×©×•×œ×—...";
  
  try {
    // ×‘×“×•×§ ×ª×—×™×œ×” ××ª ×”×¡×˜×˜×•×¡
    const statusRes = await fetch("/api/whatsapp-status");
    const status = await statusRes.json();
    
    if (!status.connected) {
      alert("âš ï¸ ×•×•××˜×¡××¤ ×œ× ××—×•×‘×¨ ×›×¨×’×¢");
      return;
    }
    
    const phone = "0501234567"; // ×§×— ××”×××©×§
    const message = "×©×œ×•×! ×–×• ×”×•×“×¢×” ××”×××©×§";
    
    const res = await fetch("/api/send-whatsapp", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ phone, message })
    });

    const data = await res.json();
    
    if (res.ok) {
      alert("âœ… ×”×•×“×¢×” × ×©×œ×—×” ×‘×”×¦×œ×—×”!");
    } else {
      alert("âŒ ×©×’×™××”: " + data.error);
    }
  } catch (err) {
    alert("âŒ ×©×’×™××” ×‘×—×™×‘×•×¨: " + err.message);
  } finally {
    button.disabled = false;
    button.textContent = "×©×œ×— ×”×•×“×¢×”";
  }
}
ğŸ’¡ ×©×™×¤×•×¨×™× × ×•×¡×¤×™× ××•××œ×¦×™×:
×œ×•×’×™× - ×”×•×¡×£ ×•×•×™× ×¡×˜×•×Ÿ ××• ×¤×™× ×• ×œ×œ×•×’×™× ××¡×•×“×¨×™×
×˜×™×¤×•×œ ×‘×”×•×“×¢×•×ª × ×›× ×¡×•×ª - ×× ××ª×” ×¨×•×¦×” ×œ×§×‘×œ ×ª×©×•×‘×•×ª
×©××™×¨×ª ×”×™×¡×˜×•×¨×™×ª ×”×•×“×¢×•×ª - ×©××•×¨ ×‘DB ××ª×™ × ×©×œ×—×” ×›×œ ×”×•×“×¢×”
×ª×•×¨×™× - ×”×©×ª××© ×‘-Bull ××• Bee-Queue ×œ×”×•×“×¢×•×ª ×¨×‘×•×ª
××•× ×™×˜×•×¨×™× ×’ - ×”×•×¡×£ ×”×ª×¨××•×ª ×›×©×”×—×™×‘×•×¨ × ×•×¤×œ
×”×× ×ª×¨×¦×” ×©××¢×–×•×¨ ×œ×š ×œ×™×™×©× ××—×“ ××”×©×™×¤×•×¨×™× ×”××œ×”?

×›×Ÿ ×ª×¨×©×•× ×œ×™ ×¨×©×™××” ×—×“×©×” ×›×•×œ×œ ×§×•×“ ×©××•×›×œ ×œ×‘×¦×¢. ×—×©×•×‘ ×’× ×× ××©×ª××© ×¡×•×’×¨ ××ª ×”×“×¤×“×¤×Ÿ ×”×—×©×‘×•×Ÿ ×™×™×©××¨ ××—×•×‘×¨ ×œ×¦×•×¨×š ×”××©×š ×¤×¢×™×œ×•×ª ×¢×“ ×©×œ× ×ª×œ×—×¥ ×¢×œ ×”× ×ª×§×•×ª. ×©××™×¨×” ×©×œ ×”×”×•×“×¢×•×ª ×‘×“××˜× ×‘×™×™×¡ ×‘×›×¨×˜×™×¡ ×”××•×¢××“ ×¢× ×ª××¨×™×›×™× ×›×Ÿ ×ª×•×¡×™×£ ×”×ª×¨××” ×× â€‹â€‹×”×—×™×‘×•×¨ × ×•×¤×œ

×›×Ÿ ×¢×›×©×™×• ×ª×©×œ×— ×œ×™ ×ª×•×›× ×™×ª ×¢×‘×•×“×” ××¡×•×“×¨×ª ×›×•×œ×œ ×”×¡×‘×¨×™× ×•×§×•×“ ×‘×¦×•×¨×” ××¡×•×“×¨×ª

ğŸ“‹ ×ª×•×›× ×™×ª ×¢×‘×•×“×” ××œ××” - ×©×™×œ×•×‘ WhatsApp ×‘-CRM
××” × ×‘× ×”:
××¢×¨×›×ª WhatsApp ×¢× ×—×™×‘×•×¨ ××ª××©×š
×©××™×¨×ª ×”×•×“×¢×•×ª ×‘-MongoDB
×”×ª××¨×•×ª ×¢×œ × ×™×˜×•×§
×××©×§ × ×™×”×•×œ ××œ×
×©×œ×‘ 1: ×”×ª×§× ×ª ×›×œ ×”×¡×¤×¨×™×•×ª ×”×’×‘×•×”×•×ª
×œÖ·×—Ö²×‘×•Ö¹×˜
npm install @whiskeysockets/baileys express mongoose dotenv winston qrcode-terminal nodemailer
×”×¡×¤×¨ ×”×¡×¤×¨×•×ª:

baileys- ×—×™×‘×•×¨ ×œ×•×•××¦××¤
mongoose- ×¢×‘×•×“×” ×¢× MongoDB
winston- ×œ×•×’×™× ××ª×§×“××™×
qrcode-terminal- ×”×¦×’×ª QR ×‘×˜×¨××™× ×œ
nodemailer- ×©×œ×™×—×ª ×”×ª×¨××•×ª ×‘××™×™×œ
×©×œ×‘ 2: ××‘× ×” ×ª×™×§×™×•×ª
/your-crm
â”œâ”€â”€ /config
â”‚   â””â”€â”€ database.js
â”œâ”€â”€ /models
â”‚   â”œâ”€â”€ WhatsAppMessage.js
â”‚   â””â”€â”€ Candidate.js
â”œâ”€â”€ /services
â”‚   â””â”€â”€ /whatsapp
â”‚       â”œâ”€â”€ whatsapp.js
â”‚       â””â”€â”€ notifications.js
â”œâ”€â”€ /routes
â”‚   â””â”€â”€ whatsapp.routes.js
â”œâ”€â”€ /utils
â”‚   â””â”€â”€ logger.js
â”œâ”€â”€ .env
â””â”€â”€ server.js
×©×œ×‘ 3: ×§×•×‘×¥ ×”×’×“×¨×•×ª -.env
×¡×‘×™×‘×”
# MongoDB
MONGODB_URI=mongodb://localhost:27017/crm_whatsapp

# Server
PORT=3000
NODE_ENV=production

# Email Notifications (××•×¤×¦×™×•× ×œ×™)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=your-email@gmail.com
EMAIL_PASS=your-app-password
ADMIN_EMAIL=admin@yourcompany.com

# WhatsApp
WHATSAPP_SESSION_PATH=./auth_info
MAX_RECONNECT_ATTEMPTS=5
×©×œ×‘ 4: ××¢×¨×›×ª ×œ×•×’×™× -/utils/logger.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp({ format: 'YYYY-MM-DD HH:mm:ss' }),
    winston.format.errors({ stack: true }),
    winston.format.splat(),
    winston.format.json()
  ),
  defaultMeta: { service: 'whatsapp-service' },
  transports: [
    // ×©××™×¨×” ×‘×§×•×‘×¥ ×œ×©×’×™××•×ª
    new winston.transports.File({ 
      filename: 'logs/error.log', 
      level: 'error',
      maxsize: 5242880, // 5MB
      maxFiles: 5,
    }),
    // ×©××™×¨×” ×‘×§×•×‘×¥ ×œ×›×œ ×”×œ×•×’×™×
    new winston.transports.File({ 
      filename: 'logs/combined.log',
      maxsize: 5242880,
      maxFiles: 5,
    }),
    // ×”×¦×’×” ×‘×§×•× ×¡×•×œ
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    })
  ]
});

export default logger;
×©×œ×‘ 5: ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™× -/config/database.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import mongoose from 'mongoose';
import logger from '../utils/logger.js';

export async function connectDatabase() {
  try {
    await mongoose.connect(process.env.MONGODB_URI, {
      useNewUrlParser: true,
      useUnifiedTopology: true,
    });
    logger.info('âœ… MongoDB ××—×•×‘×¨ ×‘×”×¦×œ×—×”');
  } catch (error) {
    logger.error('âŒ ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-MongoDB:', error);
    process.exit(1);
  }
}

// ×˜×™×¤×•×œ ×‘× ×™×ª×•×§
mongoose.connection.on('disconnected', () => {
  logger.warn('âš ï¸ MongoDB ×”×ª× ×ª×§');
});

mongoose.connection.on('reconnected', () => {
  logger.info('ğŸ”„ MongoDB ×”×ª×—×‘×¨ ××—×“×©');
});
×©×œ×‘ 6: ××•×“×œ×™× -/models/WhatsAppMessage.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import mongoose from 'mongoose';

const whatsappMessageSchema = new mongoose.Schema({
  candidateId: {
    type: mongoose.Schema.Types.ObjectId,
    ref: 'Candidate',
    required: true,
    index: true
  },
  phone: {
    type: String,
    required: true,
    index: true
  },
  message: {
    type: String,
    required: true
  },
  direction: {
    type: String,
    enum: ['outgoing', 'incoming'],
    default: 'outgoing'
  },
  status: {
    type: String,
    enum: ['pending', 'sent', 'delivered', 'read', 'failed'],
    default: 'pending'
  },
  messageId: String,
  error: String,
  metadata: {
    sentBy: String, // ×©× ×”××©×ª××© ×©×©×œ×—
    sentByUserId: mongoose.Schema.Types.ObjectId,
  }
}, {
  timestamps: true // ×™×•×¡×™×£ createdAt ×•-updatedAt ××•×˜×•××˜×™×ª
});

// ××™× ×“×§×¡ ××©×•×œ×‘ ×œ×—×™×¤×•×© ××”×™×¨
whatsappMessageSchema.index({ candidateId: 1, createdAt: -1 });

export default mongoose.model('WhatsAppMessage', whatsappMessageSchema);
×©×œ×‘ 7: ××•×“×œ ××•×¢××“ (×× ××™×Ÿ ×œ×š) -/models/Candidate.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import mongoose from 'mongoose';

const candidateSchema = new mongoose.Schema({
  name: {
    type: String,
    required: true
  },
  phone: {
    type: String,
    required: true,
    unique: true
  },
  email: String,
  position: String,
  status: {
    type: String,
    enum: ['new', 'contacted', 'interview', 'rejected', 'hired'],
    default: 'new'
  },
  lastWhatsAppContact: Date,
  whatsAppMessageCount: {
    type: Number,
    default: 0
  }
}, {
  timestamps: true
});

export default mongoose.model('Candidate', candidateSchema);
×©×œ×‘ 8: ××¢×¨×›×ª ×”×ª×¨××•×ª -/services/whatsapp/notifications.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import nodemailer from 'nodemailer';
import logger from '../../utils/logger.js';

let transporter = null;

// ××ª×—×•×œ ××¢×¨×›×ª ×”××™×™×œ
if (process.env.EMAIL_HOST) {
  transporter = nodemailer.createTransport({
    host: process.env.EMAIL_HOST,
    port: process.env.EMAIL_PORT,
    secure: false,
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS
    }
  });
}

export async function sendDisconnectionAlert(reason) {
  logger.error(`ğŸš¨ WhatsApp ×”×ª× ×ª×§: ${reason}`);
  
  // ×©×œ×™×—×ª ××™×™×œ (×× ××•×’×“×¨)
  if (transporter && process.env.ADMIN_EMAIL) {
    try {
      await transporter.sendMail({
        from: process.env.EMAIL_USER,
        to: process.env.ADMIN_EMAIL,
        subject: 'ğŸš¨ ×”×ª×¨××”: WhatsApp ×”×ª× ×ª×§ ×××¢×¨×›×ª ×”-CRM',
        html: `
          <div dir="rtl">
            <h2>×©×™× ×œ×‘! WhatsApp ×”×ª× ×ª×§</h2>
            <p><strong>×¡×™×‘×”:</strong> ${reason}</p>
            <p><strong>×–××Ÿ:</strong> ${new Date().toLocaleString('he-IL')}</p>
            <p>× × ×œ×”×ª×—×‘×¨ ××—×“×© ×“×¨×š ×××©×§ ×”-CRM</p>
          </div>
        `
      });
      logger.info('ğŸ“§ ×”×ª×¨××ª ××™×™×œ × ×©×œ×—×”');
    } catch (error) {
      logger.error('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ:', error);
    }
  }
  
  // ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×”×ª×¨××•×ª × ×•×¡×¤×•×ª:
  // - Slack webhook
  // - Telegram bot
  // - SMS
}

export async function sendReconnectionAlert() {
  logger.info('âœ… WhatsApp ×”×ª×—×‘×¨ ××—×“×©');
  
  if (transporter && process.env.ADMIN_EMAIL) {
    try {
      await transporter.sendMail({
        from: process.env.EMAIL_USER,
        to: process.env.ADMIN_EMAIL,
        subject: 'âœ… WhatsApp ×”×ª×—×‘×¨ ××—×“×©',
        html: `
          <div dir="rtl">
            <h2>WhatsApp ×¤×¢×™×œ ×©×•×‘!</h2>
            <p><strong>×–××Ÿ:</strong> ${new Date().toLocaleString('he-IL')}</p>
            <p>×”××¢×¨×›×ª ×¤×•×¢×œ×ª ×›×¨×’×™×œ</p>
          </div>
        `
      });
    } catch (error) {
      logger.error('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ××™×™×œ:', error);
    }
  }
}
×©×œ×‘ 9: ××•×“×•×œ WhatsApp ×”××œ× -/services/whatsapp/whatsapp.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import makeWASocket, { 
  useMultiFileAuthState, 
  fetchLatestBaileysVersion,
  DisconnectReason,
  makeCacheableSignalKeyStore
} from '@whiskeysockets/baileys';
import qrcode from 'qrcode-terminal';
import logger from '../../utils/logger.js';
import WhatsAppMessage from '../../models/WhatsAppMessage.js';
import Candidate from '../../models/Candidate.js';
import { sendDisconnectionAlert, sendReconnectionAlert } from './notifications.js';

let sock = null;
let connectionStatus = 'disconnected';
let reconnectAttempts = 0;
let qrCodeData = null;
const MAX_RECONNECT_ATTEMPTS = parseInt(process.env.MAX_RECONNECT_ATTEMPTS) || 5;

// ×¤×•×¨××˜ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
function formatPhoneNumber(phone) {
  phone = phone.replace(/\D/g, '');
  
  if (phone.startsWith('0')) {
    phone = '972' + phone.substring(1);
  }
  
  if (!phone.startsWith('972')) {
    phone = '972' + phone;
  }
  
  return phone;
}

// ×¤×•× ×§×¦×™×™×ª ×—×™×‘×•×¨ ×¨××©×™×ª
export async function connectWhatsApp() {
  try {
    const { state, saveCreds } = await useMultiFileAuthState(
      process.env.WHATSAPP_SESSION_PATH || './auth_info'
    );
    
    const { version } = await fetchLatestBaileysVersion();

    sock = makeWASocket({
      version,
      printQRInTerminal: false, // × ×˜×¤×œ ×‘×–×” ×‘×¢×¦×× ×•
      auth: {
        creds: state.creds,
        keys: makeCacheableSignalKeyStore(state.keys, logger),
      },
      defaultQueryTimeoutMs: undefined,
      keepAliveIntervalMs: 30000,
      markOnlineOnConnect: true,
      generateHighQualityLinkPreview: true,
    });

    // ×©××™×¨×ª credentials
    sock.ev.on('creds.update', saveCreds);

    // ×˜×™×¤×•×œ ×‘-QR Code
    sock.ev.on('connection.update', async (update) => {
      const { connection, lastDisconnect, qr } = update;
      
      if (qr) {
        qrCodeData = qr;
        logger.info('ğŸ“± QR Code ×—×“×© ×–××™×Ÿ');
        qrcode.generate(qr, { small: true });
      }
      
      if (connection === 'open') {
        logger.info('âœ… WhatsApp ××—×•×‘×¨ ×‘×”×¦×œ×—×”!');
        connectionStatus = 'connected';
        qrCodeData = null;
        reconnectAttempts = 0;
        
        if (reconnectAttempts > 0) {
          await sendReconnectionAlert();
        }
      } 
      else if (connection === 'close') {
        const statusCode = lastDisconnect?.error?.output?.statusCode;
        const reason = DisconnectReason[statusCode] || '×œ× ×™×“×•×¢';
        
        logger.warn(`âš ï¸ WhatsApp ×”×ª× ×ª×§. ×¡×™×‘×”: ${reason} (${statusCode})`);
        connectionStatus = 'disconnected';
        
        const shouldReconnect = statusCode !== DisconnectReason.loggedOut;
        
        if (statusCode === DisconnectReason.loggedOut) {
          logger.error('âŒ × ×“×¨×© ×œ×”×ª×—×‘×¨ ××—×“×© ×¢× QR Code');
          await sendDisconnectionAlert('×”××©×ª××© ×”×ª× ×ª×§ ××”××¢×¨×›×ª');
          qrCodeData = null;
        } 
        else if (shouldReconnect && reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
          reconnectAttempts++;
          const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
          
          logger.info(`ğŸ”„ ×× ×¡×” ×œ×”×ª×—×‘×¨ ××—×“×© ×‘×¢×•×“ ${delay/1000} ×©× ×™×•×ª (× ×™×¡×™×•×Ÿ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
          
          setTimeout(() => connectWhatsApp(), delay);
        } 
        else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
          logger.error('âŒ × ×›×©×œ×• ×›×œ × ×™×¡×™×•× ×•×ª ×”×—×™×‘×•×¨');
          await sendDisconnectionAlert(`× ×›×©×œ×• ${MAX_RECONNECT_ATTEMPTS} × ×™×¡×™×•× ×•×ª ×—×™×‘×•×¨`);
        }
      }
    });

    // ×§×‘×œ×ª ×”×•×“×¢×•×ª × ×›× ×¡×•×ª
    sock.ev.on('messages.upsert', async ({ messages, type }) => {
      if (type !== 'notify') return;
      
      for (const msg of messages) {
        if (!msg.message || msg.key.fromMe) continue;
        
        try {
          const phone = msg.key.remoteJid.replace('@s.whatsapp.net', '');
          const messageText = msg.message.conversation || 
                            msg.message.extendedTextMessage?.text || 
                            '[××“×™×”]';
          
          logger.info(`ğŸ“¥ ×”×•×“×¢×” × ×›× ×¡×ª ×-${phone}: ${messageText}`);
          
          // ×—×™×¤×•×© ××•×¢××“ ×œ×¤×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
          const candidate = await Candidate.findOne({ 
            phone: { $regex: phone.slice(-9) } // ×—×™×¤×•×© ×œ×¤×™ 9 ×¡×¤×¨×•×ª ××—×¨×•× ×•×ª
          });
          
          if (candidate) {
            // ×©××™×¨×ª ×”×”×•×“×¢×”
            await WhatsAppMessage.create({
              candidateId: candidate._id,
              phone,
              message: messageText,
              direction: 'incoming',
              status: 'delivered',
              messageId: msg.key.id
            });
            
            // ×¢×“×›×•×Ÿ ××•×¢××“
            candidate.lastWhatsAppContact = new Date();
            candidate.whatsAppMessageCount += 1;
            await candidate.save();
            
            logger.info(`ğŸ’¾ ×”×•×“×¢×” × ×©××¨×” ×œ××•×¢××“: ${candidate.name}`);
          }
        } catch (error) {
          logger.error('âŒ ×©×’×™××” ×‘×˜×™×¤×•×œ ×‘×”×•×“×¢×” × ×›× ×¡×ª:', error);
        }
      }
    });

  } catch (error) {
    logger.error('âŒ ×©×’×™××” ×§×¨×™×˜×™×ª ×‘×—×™×‘×•×¨ WhatsApp:', error);
    throw error;
  }
}

// ×©×œ×™×—×ª ×”×•×“×¢×”
export async function sendMessage(candidateId, phone, message, metadata = {}) {
  if (!isConnected()) {
    throw new Error('WhatsApp ×œ× ××—×•×‘×¨');
  }
  
  phone = formatPhoneNumber(phone);
  const jid = `${phone}@s.whatsapp.net`;
  
  try {
    // ×™×¦×™×¨×ª ×¨×©×•××” ×‘-DB ×¢× ×¡×˜×˜×•×¡ pending
    const messageDoc = await WhatsAppMessage.create({
      candidateId,
      phone,
      message,
      direction: 'outgoing',
      status: 'pending',
      metadata
    });
    
    // ×©×œ×™×—×ª ×”×”×•×“×¢×”
    const sentMsg = await sock.sendMessage(jid, { text: message });
    
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×œ×”×•×“×¢×” ×©× ×©×œ×—×”
    messageDoc.status = 'sent';
    messageDoc.messageId = sentMsg.key.id;
    await messageDoc.save();
    
    // ×¢×“×›×•×Ÿ ×”××•×¢××“
    await Candidate.findByIdAndUpdate(candidateId, {
      lastWhatsAppContact: new Date(),
      $inc: { whatsAppMessageCount: 1 }
    });
    
    logger.info(`âœ… ×”×•×“×¢×” × ×©×œ×—×” ×œ-${phone}`);
    
    return {
      success: true,
      messageId: messageDoc._id,
      phone
    };
    
  } catch (error) {
    logger.error(`âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×” ×œ-${phone}:`, error);
    
    // ×¢×“×›×•×Ÿ ×©×’×™××” ×‘-DB
    await WhatsAppMessage.findOneAndUpdate(
      { candidateId, phone, status: 'pending' },
      { 
        status: 'failed',
        error: error.message 
      },
      { sort: { createdAt: -1 } }
    );
    
    throw error;
  }
}

// ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×—×™×‘×•×¨
export function isConnected() {
  return connectionStatus === 'connected' && sock !== null;
}

// ×§×‘×œ×ª ×¡×˜×˜×•×¡ ××¤×•×¨×˜
export function getStatus() {
  return {
    connected: isConnected(),
    status: connectionStatus,
    reconnectAttempts,
    hasQR: qrCodeData !== null,
    qrCode: qrCodeData
  };
}

// × ×™×ª×•×§ ×™×“× ×™
export async function disconnect() {
  if (sock) {
    await sock.logout();
    sock = null;
    connectionStatus = 'disconnected';
    qrCodeData = null;
    logger.info('ğŸ‘‹ WhatsApp ×”×ª× ×ª×§ ×™×“× ×™×ª');
  }
}
×©×œ×‘ 10: ××¡×œ×•×œ×™× -/routes/whatsapp.routes.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import express from 'express';
import { 
  sendMessage, 
  isConnected, 
  getStatus, 
  disconnect,
  connectWhatsApp 
} from '../services/whatsapp/whatsapp.js';
import WhatsAppMessage from '../models/WhatsAppMessage.js';
import Candidate from '../models/Candidate.js';
import logger from '../utils/logger.js';

const router = express.Router();

// Rate limiting ×¤×©×•×˜
const messageQueue = new Map();
const RATE_LIMIT_MS = 3000;

// ×‘×“×™×§×ª ×¡×˜×˜×•×¡
router.get('/status', (req, res) => {
  const status = getStatus();
  res.json(status);
});

// ×—×™×‘×•×¨ ××—×“×©
router.post('/reconnect', async (req, res) => {
  try {
    if (isConnected()) {
      return res.json({ message: '×›×‘×¨ ××—×•×‘×¨' });
    }
    
    await connectWhatsApp();
    res.json({ message: '××ª×—×‘×¨...' });
  } catch (error) {
    logger.error('×©×’×™××” ×‘×—×™×‘×•×¨ ××—×“×©:', error);
    res.status(500).json({ error: error.message });
  }
});

// ×”×ª× ×ª×§×•×ª
router.post('/disconnect', async (req, res) => {
  try {
    await disconnect();
    res.json({ message: '×”×ª× ×ª×§ ×‘×”×¦×œ×—×”' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ×©×œ×™×—×ª ×”×•×“×¢×”
router.post('/send', async (req, res) => {
  try {
    const { candidateId, phone, message, sentBy, sentByUserId } = req.body;
    
    // ×•×œ×™×“×¦×™×”
    if (!candidateId || !phone || !message) {
      return res.status(400).json({ 
        error: '×—×¡×¨×™× ×¤×¨××˜×¨×™×: candidateId, phone, message × ×“×¨×©×™×' 
      });
    }
    
    // ×‘×“×™×§×ª ×—×™×‘×•×¨
    if (!isConnected()) {
      return res.status(503).json({ 
        error: 'WhatsApp ×œ× ××—×•×‘×¨ ×›×¨×’×¢',
        status: 'disconnected'
      });
    }
    
    // Rate limiting
    const lastSent = messageQueue.get(phone);
    if (lastSent && Date.now() - lastSent < RATE_LIMIT_MS) {
      return res.status(429).json({ 
        error: `×”××ª×Ÿ ${RATE_LIMIT_MS/1000} ×©× ×™×•×ª ×‘×™×Ÿ ×”×•×“×¢×•×ª` 
      });
    }
    
    // ×©×œ×™×—×”
    const result = await sendMessage(candidateId, phone, message, {
      sentBy,
      sentByUserId
    });
    
    messageQueue.set(phone, Date.now());
    
    res.json(result);
    
  } catch (error) {
    logger.error('×©×’×™××” ×‘×©×œ×™×—×ª ×”×•×“×¢×”:', error);
    res.status(500).json({ error: error.message });
  }
});

// ×§×‘×œ×ª ×”×™×¡×˜×•×¨×™×™×ª ×”×•×“×¢×•×ª ×œ××•×¢××“
router.get('/messages/:candidateId', async (req, res) => {
  try {
    const { candidateId } = req.params;
    const { limit = 50, skip = 0 } = req.query;
    
    const messages = await WhatsAppMessage.find({ candidateId })
      .sort({ createdAt: -1 })
      .limit(parseInt(limit))
      .skip(parseInt(skip))
      .lean();
    
    const total = await WhatsAppMessage.countDocuments({ candidateId });
    
    res.json({
      messages,
      total,
      hasMore: total > (parseInt(skip) + messages.length)
    });
    
  } catch (error) {
    logger.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×•×“×¢×•×ª:', error);
    res.status(500).json({ error: error.message });
  }
});

// ×¡×˜×˜×™×¡×˜×™×§×•×ª
router.get('/stats', async (req, res) => {
  try {
    const [totalMessages, sentToday, failedMessages] = await Promise.all([
      WhatsAppMessage.countDocuments(),
      WhatsAppMessage.countDocuments({
        createdAt: { 
          $gte: new Date(new Date().setHours(0, 0, 0, 0)) 
        }
      }),
      WhatsAppMessage.countDocuments({ status: 'failed' })
    ]);
    
    res.json({
      totalMessages,
      sentToday,
      failedMessages,
      successRate: totalMessages > 0 
        ? ((totalMessages - failedMessages) / totalMessages * 100).toFixed(2)
        : 100
    });
    
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

export default router;
×©×œ×‘ 11: ×©×¨×ª ×¨××©×™ -server.js
×’'××•×•×”×¡×§×¨×™×¤×˜
import express from 'express';
import dotenv from 'dotenv';
import { connectDatabase } from './config/database.js';
import { connectWhatsApp } from './services/whatsapp/whatsapp.js';
import whatsappRoutes from './routes/whatsapp.routes.js';
import logger from './utils/logger.js';

// ×˜×¢×™× ×ª ××©×ª× ×™ ×¡×‘×™×‘×”
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// CORS (×× ×¦×¨×™×š)
app.use((req, res, next) => {
  res.header('Access-Control-Allow-Origin', '*');
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
  res.header('Access-Control-Allow-Headers', 'Content-Type');
  next();
});

// Routes
app.use('/api/whatsapp', whatsappRoutes);

// Route ×‘×¨×™××•×ª
app.get('/health', (req, res) => {
  res.json({ 
    status: 'ok',
    uptime: process.uptime(),
    timestamp: new Date().toISOString()
  });
});

// ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
app.use((err, req, res, next) => {
  logger.error('×©×’×™××ª ×©×¨×ª:', err);
  res.status(500).json({ 
    error: '×©×’×™××ª ×©×¨×ª ×¤× ×™××™×ª',
    message: process.env.NODE_ENV === 'development' ? err.message : undefined
  });
});

// ××ª×—×•×œ
async function startServer() {
  try {
    // ×—×™×‘×•×¨ ×œ-DB
    await connectDatabase();
    
    // ×—×™×‘×•×¨ ×œ-WhatsApp
    logger.info('ğŸ”Œ ××ª×—×‘×¨ ×œ-WhatsApp...');
    await connectWhatsApp();
    
    // ×”×¤×¢×œ×ª ×”×©×¨×ª
    app.listen(PORT, () => {
      logger.info(`ğŸš€ Server running on port ${PORT}`);
      logger.info(`ğŸ“¡ WhatsApp API: http://localhost:${PORT}/api/whatsapp`);
    });
    
  } catch (error) {
    logger.error('âŒ ×©×’×™××” ×‘××ª×—×•×œ:', error);
    process.exit(1);
  }
}

// ×˜×™×¤×•×œ ×‘×¡×’×™×¨×” × ×§×™×™×”
process.on('SIGINT', async () => {
  logger.info('ğŸ›‘ ×¡×•×’×¨ ××ª ×”××¢×¨×›×ª...');
  process.exit(0);
});

process.on('SIGTERM', async () => {
  logger.info('ğŸ›‘ ×¡×•×’×¨ ××ª ×”××¢×¨×›×ª...');
  process.exit(0);
});

// ×”×¨×¦×”
startServer();
×©×œ×‘ 12: ×“×£ HTML ×œ× ×™×”×•×œ -/public/whatsapp-manager.html
html
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>× ×™×”×•×œ WhatsApp - CRM</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .status-card {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 15px 25px;
      border-radius: 8px;
      font-weight: 600;
    }
    
    .status-connected {
      background: #d4edda;
      color: #155724;
    }
    
    .status-disconnected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-connected .status-dot {
      background: #28a745;
    }
    
    .status-disconnected .status-dot {
      background: #dc3545;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #25D366;
    }
    
    .stat-label {
      color: #666;
      margin-top: 5px;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #25D366;
      color: white;
    }
    
    .btn-primary:hover {
      background: #128C7E;
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .qr-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      display: none;
    }
    
    .qr-section.show {
      display: block;